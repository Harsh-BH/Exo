groups:
  - name: {{.AppName}}.rules
    rules:

      # ── Availability ──────────────────────────────────────────────────────────
      - alert: ServiceDown
        expr: up{job="{{.AppName}}"} == 0
        for: 1m
        labels:
          severity: critical
          service: {{.AppName}}
        annotations:
          summary: "Service {{.AppName}} is down"
          description: "{{.AppName}} has been unreachable for more than 1 minute."

      # ── Error Rate ────────────────────────────────────────────────────────────
      - alert: HighErrorRate
        expr: |
          sum(rate(http_requests_total{job="{{.AppName}}",status=~"5.."}[5m]))
          /
          sum(rate(http_requests_total{job="{{.AppName}}"}[5m])) > 0.05
        for: 5m
        labels:
          severity: warning
          service: {{.AppName}}
        annotations:
          summary: "High error rate on {{.AppName}}"
          description: "Error rate is above 5% for the last 5 minutes (current: {{ "{{" }} $value | humanizePercentage {{ "}}" }})."

      # ── Latency ───────────────────────────────────────────────────────────────
      - alert: HighLatency
        expr: |
          histogram_quantile(0.99,
            sum(rate(http_request_duration_seconds_bucket{job="{{.AppName}}"}[5m])) by (le)
          ) > 2
        for: 5m
        labels:
          severity: warning
          service: {{.AppName}}
        annotations:
          summary: "High p99 latency on {{.AppName}}"
          description: "p99 latency is above 2s for the last 5 minutes (current: {{ "{{" }} $value | humanizeDuration {{ "}}" }})."

      # ── Memory ────────────────────────────────────────────────────────────────
      - alert: HighMemoryUsage
        expr: |
          process_resident_memory_bytes{job="{{.AppName}}"} > 500 * 1024 * 1024
        for: 10m
        labels:
          severity: warning
          service: {{.AppName}}
        annotations:
          summary: "High memory usage on {{.AppName}}"
          description: "Memory usage is above 500MB for 10 minutes (current: {{ "{{" }} $value | humanize1024 {{ "}}" }}B)."

      # ── Restarts ──────────────────────────────────────────────────────────────
      - alert: FrequentRestarts
        expr: |
          increase(kube_pod_container_status_restarts_total{container="{{.AppName}}"}[1h]) > 5
        for: 0m
        labels:
          severity: warning
          service: {{.AppName}}
        annotations:
          summary: "{{.AppName}} pod restarting frequently"
          description: "Pod has restarted more than 5 times in the last hour."
